---
layout: post
title:  "Cosmos-SDK Gas and Fees"
author: violetstair
categories: [ CosmosSDK ]
tags: [golang, programming, cosmos-sdk]
image: assets/images/cosmos-sdk.png
description: "COSMOS SDK Gas and Fees"
featured: false
hidden: true
---

## Introduction to `Gas` and `Fees`

Cosmos SDK에서 `gas`는 실행 중 리소스 소비를 추적하는데 사용되는 특수한 단위 입니다.
`gas`는 일반적으로 store에 읽고 쓸때마다 소비되지만 값 비싼 계산이 필요한 경우에도 사용될 수 있으며 다음과 같은 두 가지 주료 목적으로 제공됩니다.

- 블록이 너무 많은 리소스를 소비하지 않고 완료되어야하며 [block gas meter](#block-gas-meter)를 통해 SDK에서 기본적으로 구현됩니다.
- 최종 사용자의 스팸 및 남용을 방지합니다. 이를위해 [`message`](https://github.com/cosmos/cosmos-sdk/blob/master/docs/building-modules/messages-and-queries.md#messages) 실행 중에 소비되는 `gas`는 일반적으로 가격이 책정되어 `fee`(`fees = gas * gas-prices`)가 발생합니다. 일반적으로 `fee`는 `message`를 보낸 사랑이 지불해야 합니다. 스팸을 방지하는 다른 방법(예 : bandwidth schemes)이 있을 수 있으므로 SDK는 기본적으로 `gas` 가격을 적용하지 않습니다. 하지만 대부분의 애플리케이션은 스팸을 방지하기 위해 `fee` 매커니즘을 구현합니다. 이것은 [`AnteHandler`](#antehandler)를 통해 수행됩니다.

## Gas Meter

Cosmos SDK에서 `gas`는 `uint64`의 간단한 별칭이며 *gas meter*라는 객체에 의해 관리됩니다.
가스 계량기(Gas meters)는 `GasMeter` 인터페이스를 구현합니다.

[gas.go](https://github.com/cosmos/cosmos-sdk/blob/7d7821b9af132b0f6131640195326aa02b6751db/store/types/gas.go#L31-L39)

- `GasConsumed()` 는 gas meter 인스턴스에서 소비한 gas의 양을 반환합니다.
- `GasConsumedToLimit()` 는 gas meter 인스턴스에서 소비한 gas의 양 또는 limit에 도달한 경우를 반환 합니다.
- `Limit()` 는 gas meter 인스턴스의 limit을 반환합니다. `0`일 경우 gas meter는 무한대 입니다.
- `ConsumeGas(amount Gas, descriptor string)` 는 제공된 `gas`의 양을 소비합니다. `gas`가 넘치면 `descriptor` 메시지와 함께 패닉이 발생합니다. gas meter가 무한대가 아닌경우 소비된 가스가 한도를 초과하면 panic 상태가 됩니다.
- `IsPastLimit()` 는 gas meter 인스턴스가 소비하는 gas의 양이 엄격히 제한을 초과하면 `true`를 반환하고 그렇지 않으면 `false`를 반환합니다.
- `IsOutOfGas()` 는 gas meter 인스턴스가 소비하는 gas의 양이 한계 이상이면 `true`를 그렇지 않으면 `false`를 반환합니다.

gas meter는 일반적으로 [`ctx`](https://github.com/cosmos/cosmos-sdk/blob/master/docs/core/context.md)로 고정되며, gas 소비는 다음과 같은 패턴으로 이루어집니다.

```go
ctx.GasMeter().ConsumeGas(amount, "description")
```

기본적으로 Cosmos SDK는 [main gas meter](#main-gas-metter)와 [block gas meter](#block-gas-meter)의 두 가지 gas meter를 사용합니다.

### Main Gas Meter

`ctx.GasMeter()`는 애플리케이션의 main gas meter입니다. main gas meter는 `setDeliverState`를 통해 `BeginBlock`에서 초기화된 다음 상태 전환으로 이어지는 실행 시퀀스 중에 gas 소비를 추적합니다. 즉 [`BeginBlock`](https://github.com/cosmos/cosmos-sdk/blob/master/docs/core/baseapp.md#beginblock), [`DeliverTx`](https://github.com/cosmos/cosmos-sdk/blob/master/docs/core/baseapp.md#delivertx) 및 [`EndBlock`](https://github.com/cosmos/cosmos-sdk/blob/master/docs/core/baseapp.md#endblock)에 의해 트리거 됩니다. 각 `DeliverTx`의 시작 부분에서 main gas meter는 [`AnteHandler`](#antehandler)에서 **반드시 0으로 설정**해야 거래당 gas 소비량을 추적할 수 있습니다.

gas 소비는 일반적으로 모듈 개발자가 [`BeginBlocker`, `EndBlocker`](https://github.com/cosmos/cosmos-sdk/blob/master/docs/building-modules/beginblock-endblock.md) 또는 [`handler`](https://github.com/cosmos/cosmos-sdk/blob/master/docs./building-modules/handler.md)에서 수동으로 수행할 수 있지만 대부분의 경우 store에 대한 읽기 또는 쓰기가 있을때 마다 자동으로 수행됩니다. 이 자동 gas 소비 로직은 [`GasKv`](https://github.com/cosmos/cosmos-sdk/blob/master/docs/core/store.md#gaskv-store)라는 특별한 store에서 구현됩니다.

### Block Gas Meter

`ctx.BlockGasMeter()`는 블록 당 gas 소비량을 추적하고 특정 한도를 초과하지 않는지 확인하는데 사용되는 가스 계량기(gas meter)입니다.
[`BeginBlock`](https://github.com/cosmos/cosmos-sdk/blob/master/docs/core/baseapp.md#beginblock)이 호출될때마다 `BlockGasMeter`의 새 인스턴스가 생성됩니다.
`BlockGasMeter`는 유한하며 블록당 gas 제한은 애플리케이션의 합의 매개 변수에서 정의됩니다.
기본적으로 Cosmos SDK 애플리케이션은 Tendermint에서 제공하는 기본 합의 매개 변수를 사용합니다.

[params.go](https://github.com/tendermint/tendermint/blob/f323c80cb3b78e123ea6238c8e136a30ff749ccc/types/params.go#L65-L72 )

새로운 [transaction](https://github.com/cosmos/cosmos-sdk/blob/master/docs/core/transactions.md)이 `DeliverTx`를 통해 처리될 때 `BlockGasMeter`의 현재 값이 한도를 초과하는지 확인합니다. 그렇다면 `DeliverTx`는 즉시 반환됩니다. 이것은 `BeginBlock` 자체가 gas를 소비할 수 있기 때문에 블록의 첫 번째 트랜잭션에서도 발생할 수 있습니다. 그렇지 않으면 transaction이 정상적으로 처리됩니다. `DevliverTx`가 끝나면 `ctx.BlockGasMeter()`가 추적하는 gas가 transaction 처리에 소비되는 양만큼 증가합니다.

```go
ctx.BlockGasMeter().ConsumeGas(
    ctx.GasMeter().GasConsumedToLimit(),
    "block gas meter",
)
```

## AnteHandler

`AnteHandler`는 트랜잭션에서 각 `message`의 `handler` 전에 `CheckTx` 및 `DeliverTx` 동안 모든 트랜잭션에 대해 실행되는 특수한 `handler`입니다.
`AnteHandler`는 `handler`와 다른 서명을 갖습니다.:

```go
// AnteHandler는 내부 메시지가 처리되기 전에 트랜잭션을 인증합니다.
// 만약 newCtx.IsZero()이면 대신 ctx가 사용됩니다.
type AnteHandler func(ctx Context, tx Tx, simulate bool) (newCtx Context, result Result, abort bool)
```

`anteHandler`는 core SDK가 아니라 모듈로 구현됩니다. 이를통해 개발자는 애플리케이션의 요구에 맞는 `anteHandler` 버전을 선택할 수 있습니다. 즉 대부분의 애플리케이션은 [`auth` module](https://github.com/cosmos/cosmos-sdk/tree/master/x/auth)에 정의된 기본 구현을 사용합니다. 일반 Cosmos SDK 애플리케이션에서 `anteHandler`가 수행하는 작업은 다음과 같습니다.

- 트랜잭션 유형이 올바른지 확인합니다. 트랜잭션 유형은 `anteHandler`를 구현하는 모듈에서 정의되며 트랜잭션 인터페이스를 따릅니다:
  - [tx_msg.go](https://github.com/cosmos/cosmos-sdk/blob/7d7821b9af132b0f6131640195326aa02b6751db/types/tx_msg.go#L33-L41)
이를 통해 개발자는 애플리케이션 트랜잭션을 위해 다양한 유형을 사용할 수 있습니다. 기본 `auth` 모듈에서 표준 트랜잭션 유형은 `StdTx` 입니다.:
  - [stdtx.go](https://github.com/cosmos/cosmos-sdk/blob/7d7821b9af132b0f6131640195326aa02b6751db/x/auth/types/stdtx.go#L22-L29)
- 트랜잭션에 포함된 각 [`message`](https://github.com/cosmos/cosmos-sdk/blob/master/docs/building-modules/03-messages-and-queries.md#messages)의 서명을 확인합니다. 각 `message`는 한명 또는 여러 발신자가 서명해야하며 이러한 서명은 `anteHandler`에서 확인되어야 합니다.
-`CheckTx` 중에 트랜잭션과 함께 제공된 gas의 가격이 노드의 `min-gas-prices`보다 높은지 확인합니다. 참고로 gas 가격은 `fee = gas * gas-prices` 등식을 통해 공제할 수 있습니다. `min-gas-prices`는 각 전체 노드에 로컬인 매개 변수이며 `CheckTx`중에 최소 fee를 제공하지 않는 트랜잭션을 폐기하는데 사용합니다. 이렇게 하면 mempool이 garbage 트랜잭션으로부터 스팸을 받지 않을 수 있습니다.
- 트랜잭션 발신자가 `fee`를 충당할 수 있는 충분한 자금이 있는지 확인 합니다. 최종 사용자가 트랜잭션을 생성할 때 `fees`, `gas`, `gas-prices` 3개의 매개변수 중 2개를 표시해야 합니다(마지막 하나는 암시적으로 적용됩니다). 이는 노드가 트랜잭션을 실행하기 위해 지불할 의사가 있는 금액을 나타냅니다. 제공된 `gas` 값은 나중에 사용하기 위해 `GasWanted`라는 매개 변수에 저장됩니다.
- `newCtx.GasMeter`를 0으로 설정하고 `GasWanted`를 제한합니다. **이 단계는 매우 중요한데** 트랜잭션이 gas 무한 소비를 하지 못하도록 할 뿐만 아니라 각 `DeliverTx`사이에 `ctx.GasMeter`가 재설정 되기 때문입니다. `anteHandler`가 실행된 후 `ctx`가 `newCtx`로 설정되고 `DeliverTx`가 호출될 때 마다 `anteHander`가 실행됩니다.

위에 설명한대로 `anteHandler`는 트랜잭션이 실행중에 소비할 수 있는 `GasWanted`라는 `gas`의 최대 한계를 리턴합니다.
결국 실제 소비되는 양은 `GasUsed`로 표시되므로 `GasUsed <= GasWanted`가 되게 됩니다.
`GasWanted`와 `GasUsed`는 [`DeliverTx`](https://github.com/cosmos/cosmos-sdk/blob/master/docs/core/baseapp.md#delivertx)가 반환될 떄 기본 함의 엔진으로 전달됩니다.
