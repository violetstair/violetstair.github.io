---
layout: post
title:  "Cosmos-SDK Scavenge 04"
author: violetstair
categories: [ CosmosSDK ]
tags: [Golang, Programming]
image: assets/images/cosmos-sdk.png
description: "COSMOS SDK로 만들어보는 현상금 사냥꾼 게임"
featured: false
hidden: true
---

## Keeper

`scaffold`를 이용해 `Keeper`의 boilerplate인 `./x/scavenge/keeper/keeper.go` 파일을 생성합니다.
이 파일 안에는 `Set`, `Get`, `Delete`와 같은 keeper의 기본 기능들이 포함되어 있습니다.
keeper는 모듈에서 생성한 모든 데이터를 저장하며, 다른 keeper 모듈을 import해 사용하기도 하며, 이를통해 모듈간 상태 정보 공유 및 정보를 저장할 수 있습니다.

문제에 대한 보상을 코인으로 다루기 때문에 `bank` 모듈의 keeper에 접근할 수 있어야 한다. (`CoinKeeper`라고 명칭함)
완성된 `Keeper`를 보면 `bank` keeper의 사용과 `Set`, `Get`, `Delete` 기능의 확장을 볼 수 있습니다.

[keeper](https://github.com/cosmos/sdk-tutorials/tree/master/scavenge/x/scavenge/keeper/keeper.go)

### Commits and Scavenges

`types.Commit`와 `types.Scavenge`에 대한 참조를 `Keeper`에서 확인할 수 있는데, `./x/scavenge/types/types.go`에 정의된 구조체로, scavenge에 필요한 정보, 모든 도전에 대한 정보, 서로 다른 commit에 대한 정보를 포함합니다.
`Msg`의 types와 비슷한 정보를 포함하고 있기 때문에 유사한 형태를 띈다.
다음과 같이 파일을 만들고 수정한다.

[types](https://github.com/cosmos/sdk-tutorials/tree/master/scavenge/x/scavenge/types/types.go)

해결 되지 않은 `Scavenge`는 해결되기 전까지 `Solutions` 및 `Scavenger` 필드에 대해 `nil` 값을 포함한다고 가정할 수 있다.
또한 각 유형에는 `String` 메소드가 있는걸 볼 수 있는데, 이를 통해 구조체를 렌더링 을위한 문자열로 렌더링 할 수 있습니다.

### Prefixes

이제 `types.ScavengePrefix`와 `types.CommitPrefix`를 사용할 수 있습니다.
이것들은 `./x/scavenge/types/key.go`에 정의 되어 있으며 `Keeper`를 정리하는데 도움이 됩니다.
'Keeper'는 실제로 Key-Value Store입니다.
자바스크립트의 `object`와 유사하게 value는 key아래에 참조 됩니다.
value에 접근하기 위해서는 key를 알아야 하며, 이는 고유 식별자(UID)와 비슷합니다.

`Scavenge`를 저장할 때 `SolutionHash`의 key를 고유 ID로 사용하고 `Commit`에는 `SolutionScavengeHash`를 key로 사용합니다.
그러나 이 두가지 데이터 유형을 동일한 위치에 저장하고 있으므로 key로 사용하는 Hash 유형을 구분할 수 없으므로 Hash에 prefix를 추가하려 구분하도록 합니다.
`Scavenge`의 경우 prefix `sk-`를 추가하고 `Commit`의 경우 prefix `ck-`를 추가하도록 합니다
이에 대한 정보는 `key.go` 파일에 정의 합니다.

[key](https://github.com/cosmos/sdk-tutorials/tree/master/scavenge/x/scavenge/types/key.go)

### Iterators

상황에 따라서 `Commit`과 `Scavenge`를 하나씩 직접 접근하거나, 여러개를 조회하고 싶을 것 입니다.
직접 접근을 위해 `GetCommit`과 `GetScavenge` 메소드를 이용할 수있습니다.
여러개의 목록을 조회할 때는 `sdk`에서 제공하는 `KVStorePrefixIterator`라는 **Iterator**를 사용해 iterable한 데이터를 조회할 수 있습니다.
prefix를 이용해 해당 prefix를 포함하는 key에 대해서만 접근할 수 도 있습니다.
`Scavenge`와 `Commit`에 대해 정의된 prefix가 있으므로 이를 통해 원하는 데이터만 조회할 수 있습니다.

---

이제 모든 `Commit` 및`Scavenge`가 저장되는 `Keeper`를 만들었으니 storage에 메시지를 연결해야합니다.
이 프로세스를 메시지 _handling_ 이라고 하며 `Handler`내부에서 수행됩니다.
