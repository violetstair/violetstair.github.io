---
layout: post
title:  "Cosmos-SDK Accounts"
author: violetstair
categories: [ CosmosSDK ]
tags: [golang, programming, cosmos-sdk]
image: assets/images/cosmos-sdk.png
description: "COSMOS SDK Accounts"
featured: false
hidden: true
---

## Account Definition

Cosmos SDK에서 *account*는 *public key*`PubKey`와 *private key*`PrivKey` 쌍을 지정합니다.
`PubKey`는 애플리케이션에서 사용자를 식별하는데 사용되는 다양한 `Address`를 생성하기 위해 파생될 수 있습니다.
`Address`는 [`message`s](https://github.com/cosmos/cosmos-sdk/blob/master/docs/building-modules/messages-and-queries.md#messages)와도 연결됩니다.
`PrivKey`는 주어진 `message`를 승인한 `PrivKey`와 연관된 `Address`를 증명하기 위해 [디지털 서명](#signatures)을 생성하는데 사용됩니다.

`PubKey`와 `PrivKey`를 파생하기위해 Cosmos SDK는 [BIP32](https://github.com/bitcoin/bips/blob/master/bip-0032.mediawiki)라는 표준을 사용합니다.
이 표준은 일종의 계정이라고 볼 수 있는 HD 지갑을 생성하는 방법을 정의합니다.
이 mnemonic에서 단방향 암호화 기능을 사용하여 원하는 수의 `PrivKey`를 파생할 수 있으며, `PrivKey`에서 `PubKey`를 파생할 수 있습니다.
mnemonic이 보존되면 private key가 항상 다시 생성될 수 있으므로 mnemonic은 가장 민감한 정보 입니다.

```text
     Account 0                         Account 1                         Account 2

+------------------+              +------------------+               +------------------+
|                  |              |                  |               |                  |
|    Address 0     |              |    Address 1     |               |    Address 2     |
|        ^         |              |        ^         |               |        ^         |
|        |         |              |        |         |               |        |         |
|        |         |              |        |         |               |        |         |
|        |         |              |        |         |               |        |         |
|        +         |              |        +         |               |        +         |
|  Public key 0    |              |  Public key 1    |               |  Public key 2    |
|        ^         |              |        ^         |               |        ^         |
|        |         |              |        |         |               |        |         |
|        |         |              |        |         |               |        |         |
|        |         |              |        |         |               |        |         |
|        +         |              |        +         |               |        +         |
|  Private key 0   |              |  Private key 1   |               |  Private key 2   |
|        ^         |              |        ^         |               |        ^         |
+------------------+              +------------------+               +------------------+
         |                                 |                                  |
         |                                 |                                  |
         |                                 |                                  |
         +--------------------------------------------------------------------+
                                           |
                                           |
                                 +---------+---------+
                                 |                   |
                                 |  Master PrivKey   |
                                 |                   |
                                 +-------------------+
                                           |
                                           |
                                 +---------+---------+
                                 |                   |
                                 |  Mnemonic (Seed)  |
                                 |                   |
                                 +-------------------+
```

Cosmos SDK에서 account는 [`Keybase`](#keybase)라는 개채를 통해 저장 및 관리 됩니다.

## Keybase

`Keybase`는 account를 저장하고 관리하는 개체입니다. Cosmos SDK에서 `KeyBase` 구현은 `KeyBase` 인터페이스를 따릅니다.

[types.go](https://github.com/cosmos/cosmos-sdk/blob/7d7821b9af132b0f6131640195326aa02b6751db/crypto/keys/types.go#L13-L86)

Cosmos SDK의 `Keybase`의 기본 구현은 `dbKeybase`입니다.

[keybase.go](https://github.com/cosmos/cosmos-sdk/blob/7d7821b9af132b0f6131640195326aa02b6751db/crypto/keys/keybase.go)

`dbKeybase`에 구현된 `Keybase` 메소드에 대한 몇 가지 참고사항:

- `Sign(name, passphrase string, msg []byte) ([]byte, crypto.PubKey, error)`는`message` 바이트의 서명을 엄격하게 다룹니다. `message`를 표준 `[]byte` 형식으로 준비하고 인코딩 하려면 사전에 몇 가지 예비 작업을 수행해야 합니다. `auth` 모듈의 `message` preparation 예제를 참조하세요. 서명 확인은 기본적으로 SDK에서 구현되지 않습니다.
  - [txbuilder.go](https://github.com/cosmos/cosmos-sdk/blob/7d7821b9af132b0f6131640195326aa02b6751db/x/auth/types/txbuilder.go#L176-L209)
- `CreateMnemonic(name string, language Language, passwd string, algo SigningAlgo) (info Info, seed string, err error)`는 새로운 mnemonic을 생성합니다. 로그가 출력되긴 하지만 **디스크에 저장되지는 않습니다**.
- `CreateAccount(name, mnemonic, bip39Passwd, encryptPasswd string, account uint32, index uint32) (Info, error)`는 [`bip44 path`](https://github.com/bitcoin/bips/blob/master/bip-0044.mediawiki)를 기반으로 새 계정을 생성하고 디스크에 유지합니다. `PrivKey`는 [저장되기 전에 암호로 암호화](https://github.com/cosmos/cosmos-sdk/blob/7d7821b9af132b0f6131640195326aa02b6751db/crypto/keys/mintkey/mintkey.go)되며 **암호화되지 않은 상태로는 저장되지 않습니다**. 이 방법의 맥락에서 `account` 및 `address` 매개변수는 `PrivKey`를 파생하는데 사용되는 BIP44 파생 경로(예 : `0`, `1`, `2`, ...)의 세그먼트를 참조합니다. mnemonic에서 `PubKey`가 있습니다. 동일한 mnemonic과 `account`가 주어지면 동일한 `PrivKey`가 생성되고 동일한 `account`와 `address`가 주어지면 동일한 `PubKey`와 `address`가 생성됩니다. 마지막으로 `CreateAccount` 메소드는 [Tendermint library](https://github.com/tendermint/tendermint/tree/bc572217c07b90ad9cee851f193aaa8e9557cbc7/crypto/secp256k1)에 구현된 `secp256k1`을 사용하여 key와 주소를 파생합니다. 결과적으로 컨센서스 키가 아닌 account key와 address를 만드는 경우에만 작동합니다. 자새한 내용은 [`Addresses`](#addresses)를 참조하세요

현재 `dbKeybase` 구현은 기본이며 주문형 잠금(on-demand locking)은 제공하지 않습니다. `dbKeybase`의 인스턴스가 생성되면 기본 `db`가 잠기므로 인스턴스화된 프로세스외에 다른 프로세스가 액세스할 수 없습니다. 이것이 기본 SDK 클라이언트가 `lazyKeybase`라는 `Keybase` 인터페이스의 또 다른 구현을 사용하는 이유입니다.

[lazy_keybase.go](https://github.com/cosmos/cosmos-sdk/blob/7d7821b9af132b0f6131640195326aa02b6751db/crypto/keys/lazy_keybase.go)

`lazyKeybase`는 작업이 수행될 때만 데이터베이스를 잠그고 즉시 잠금을 해제하는 `dbKeybase`를 둘러싼 간단한 wrapper입니다. `lazyKeybase`를 사용하면 [rest server](https://github.com/cosmos/cosmos-sdk/blob/master/docs/interfaces/rest.md)가 실행되는 동안 [command-line interface](https://github.com/cosmos/cosmos-sdk/blob/master/docs/interfaces/cli.md)에서 새 계정을 만들 수 있습니다. 여러 CLI 명령을 파이프할 수 도 있습니다.

## Addresses and PubKeys

`Addresses`와 `PubKey`는 모두 애플리케이션에서 사용자를 식별하는 공개 정보입니다.
Cosmos SDK는 기본적으로 사용할 수 있는 3가지 유형의 `Addresses`/`PubKeys`가 있습니다.:

- 사용자를 식별하는 **accounts**의 Addresses와 Keys (예 : `message`의 전송자). **`secp256k1`** 를 사용하여 파생됩니다..
- validator 노드의 운영자를 식별하는 **validator operators**의 Addresses와 Keys. **`secp256k1`** 를 사용하여 파생됩니다.
- 합의에 참여하는 컨센서스 노드를 식별하는 **consensus nodes**의 Addresses와 Keys. **`ed25519`** 를 사용하여 파생됩니다.

|                    | Address bech32 Prefix | Pubkey bech32 Prefix | Curve       | Address byte length | Pubkey byte length |
|--------------------|-----------------------|----------------------|-------------|---------------------|--------------------|
| Accounts           | cosmos                | cosmospub            | `secp256k1` | `20`                | `33`               |
| Validator Operator | cosmosvaloper         | cosmosvaloperpub     | `secp256k1` | `20`                | `33`               |
| Consensus Nodes    | cosmosvalcons         | cosmosvalconspub     | `ed25519`   | `20`                | `32`               |

### PubKeys

Comos SDK에서 사용되는 `PubKey`는 tendermint의 `crypto` 패키지에 정의된 `Pubkey` 인터페이스를 따릅니다.

[crypto.go](https://github.com/tendermint/tendermint/blob/bc572217c07b90ad9cee851f193aaa8e9557cbc7/crypto/crypto.go#L22-L27)

`secp256k1` 키의 실제 구현은 [여기](https://github.com/tendermint/tendermint/blob/bc572217c07b90ad9cee851f193aaa8e9557cbc7/crypto/secp256k1/secp256k1.go#L140)에서 찾을 수 있습니다.
`ed25519` 키의 실제 구현은 [여기](https://github.com/tendermint/tendermint/blob/bc572217c07b90ad9cee851f193aaa8e9557cbc7/crypto/ed25519/ed25519.go#L135)에서 확인할 수 있습니다..

Comos SDK에서 `Pubkeys`는 조작되지 않는 Raw 형태입니다.
대신 [`Amino`](https://github.com/cosmos/cosmos-sdk/blob/master/docs/core/encoding.md#amino) 및 [`bech32`](https://en.bitcoin.it/wiki/Bech32)를 사용하여 이중 인코딩 됩니다.
SDK에서는 먼저 Raw `Pubkey`(amino 인코딩을 적용하는)에서 `Bytes()` 메서드를 호출한 다음 `bech32`의 `ConvertAndEncode` 메소드를 호출하여 수행됩니다.

[address.go](https://github.com/cosmos/cosmos-sdk/blob/7d7821b9af132b0f6131640195326aa02b6751db/types/address.go#L579-L729)

### Addresses

Cosmos SDK는 기본적으로 3가지 타입의 address가 존재합니다.:

- 계정의 주소인 `AccAddress`.
- 검증자 노드 운영자의 주소인 `ValAddress`.
- 검증 노드의 주소인 `ConsAddress`.

이러한 각 address type은 길이가 20인 16진수 인코딩 `[]byte` 배열의 별칭입니다. 다음은 `Pubkey pub`에서 address `aa`얻는 표준 방법입니다.

```go
aa := sdk.AccAddress(pub.Address().Bytes())
```

이 주소는 `Address` 인터페이스를 구현합니다.

[address.go](https://github.com/cosmos/cosmos-sdk/blob/7d7821b9af132b0f6131640195326aa02b6751db/types/address.go#L71-L80)

참고로 `Marsal()`과 `Bytes()` 메서드는 모두 동일한 raw `[]byte` 형식의 address를 반환하며 전자는 Protobuff 호환성을 위해 필요합니다.
또한 `String()` 메소드는 최종 사용자가 상호 작용하는 유일한 address 여야하는 `bech32`로 인코딩 된 address 형식을 반환하는데 사용됩니다.

[address.go](https://github.com/cosmos/cosmos-sdk/blob/7d7821b9af132b0f6131640195326aa02b6751db/types/address.go#L229-L243)
